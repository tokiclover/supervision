#!/bin/sh
#
# $Header:  /lib/sv/sh/dep                               Exp $
# $Author: (c) 2015-6 tokiclover <tokiclover@gmail.com>  Exp $
# $License: 2-clause/new/simplified BSD                  Exp $
# $Version: 1.0 2016/07/28 21:09:26                      Exp $
#

SV_CGROUP=0
export LC_ALL=C LANG=C
:	${name=${0##*/}}
:	${SV_LIBDIR:=${0%/sh/*}}
source "${0%/*}"/runscript-functions ||
	{ echo "Required file not found." >&2; exit 1; }
SV_DEPDIR="${SV_TMPDIR}/deps"

add_dep()
{
	local svc="${1}" dep="${2%:*}" DEP="${2#*:}"

	shift 2
	if [ "${#}" -gt 0 ]; then
		echo "${svc}:${dep}=\"${@}\"" >&4
	fi
}
dep_gen()
{
	local RC_OPTS SVC_DEBUG SVC_NAME SVC_NEED SVC_USE SVC_BEFORE SVC_AFTER name
	local dep SVC_PROVIDE

	if [ -d "${SV_SVCDIR}/${1}" ]; then
		SVC_DIR="${SV_SVCDIR}/${1}" RS_TYPE=sv
	else
		SVC_DIR="${SV_SVCDIR}"      RS_TYPE=rs
	fi
	SERVICE_LIST="${SERVICE_LIST} ${1}"
	SVC_NAME="${1}"
	shift
	source ${SV_SVCDIR}/.opt/SVC_OPTIONS

	for dep in ${__SV_DEPS_ORDER__} ${DEPS}; do
		eval add_dep "${SVC_NAME}" "${dep}" \${SVC_${dep#*:}}
	done
}

dep_scan()
{
	local dir svc

	DEPS=provide:PROVIDE
	for dir in ${@:-${SV_SVCDIR}}; do
		cd ${dir}
		for svc in *; do
			dep_gen "${svc}"
		done
	done
}

exec 4>${SV_DEPDIR}/svcdeps
dep_scan
echo ${SERVICE_LIST} >${SV_DEPDIR}/svclist

#
# vim:fenc=utf-8:ft=sh:ci:pi:sts=0:sw=4:ts=4:
#
