#!/bin/sh
#
# $Header:  /lib/sv/bin/checkpath                        Exp $
# $License: 2-clause/new/simplified BSD                  Exp $
# $Description: Simple & Cheap checkpath/mktemp script   Exp $
# $Version: 0.6 2015/04/24 21:09:26                      Exp $
#

name="${0##*/}"
case "${0}" in
	(/*) head="${0%/*}"   ;;
	(*)  head="${PWD}/${0#./}"
	     head="${head%/*}";;
esac
:	${SV_LIBDIR:=${head%/*}}
source ${SV_LIBDIR}/sh/sv-backend ||
	{ echo "Required file not found." >&2; exit 1; }

usage() {
	cat <<-EOH
usage: ${0##*/} [-M] [-d|-f] [-m mode] [-o owner[:group]] TEMPLATE|DIR|FILE
  -d, --dir           (Create a) directory
  -f, --file          (Create a) file
  -p, --pipe          (Create a) pipe (FIFO)
  -o, --owner <name>  Use owner name
  -g, --group <name>  Use group name
  -m, --mode <1700>   Use octal mode
  -c, --checkpath     Enable check mode
  -M, --mktemp        Enable mktmp mode
  -q, --quiet         Enable quiet mode
  -h, --help          Help/Exit
EOH
exit
}

[ ${#} -eq 0 ] && usage
ARGS="$(getopt \
	-o Mcdfg:hm:o:pq \
	-l checkpath,dir,file,group: \
	-l help,mode:,owner:,pipe,quiet \
	-s sh -n ${name} -- "${@}")"
[ ${?} -eq 0 ] || usage
eval set -- ${ARGS}

TEMP=-XXXXXX TYPE='' TMPDIR="${TMPDIR:-/tmp}"
while true; do
	case "${1}" in
		(-c|--chec*) TASK=chk  ;;
		(-M|--mkte*) TASK=tmp  ;;
		(-d|--dir)   TYPE=dir  ;;
		(-f|--file)  TYPE=file ;;
		(-p|--pipe)  TYPE=pipe ;;
		(-h|--help)  usage     ;;
		(-q|--quiet) QUIET=true;;
		(-m|--mode)  MODE="${2}" ; shift;;
		(-o|--owner) OWNER="${2}"; shift;;
		(-g|--group) GROUP="${2}"; shift;;
		(*)        shift; break;;
	esac
	shift
done
[ ${#} -eq 1 -a -n "${1}" ] || die "Invalid argument(s)/TEMPLATE"

case "${TASK}" in
	(tmp)
	[ "${1%$temp}" = "$1" ] && die "Invalid TEMPLATE"
	type -p uuidgen >/dev/null 2>&1 && TEMP=$(uuidgen --random)
	TMP="${TMPDIR}/${1%${TEMP}}-$(echo -n ${TEMP} | cut -b1-6)"
	QUIET=
	;;
	(*)
	TMP="${1}"
	;;
esac
case "${TYPE}" in
	(dir)
	[ -d "${TMP}" ] || mkdir -p "${TMP}"
	;;
	(*)
	[ -e "${TMP}" ] || mkdir -p "${TMP%/*}" && break
	case "${TYPE}" in
		(pipe) mkfifo "${TMP}";;
		(file) touch  "${TMP}";;
	esac
	;;
esac

[ ${?} -eq 0    ] || die "Failed to create ${TMP}"
[ -h "${TMP}"   ] && return
[ -n "${OWNER}" ] && chown "${OWNER}" "${TMP}"
[ -n "${GROUP}" ] && chgrp "${GROUP}" "${TMP}"
[ -n "${MODE}"  ] && chmod "${MODE}"  "${TMP}"
[ -n "${QUIET}" ] || echo "${TMP}"

unset GROUP MODE OWNER QUIET TEMP TMP TYPE

#
# vim:fenc=utf-8:ft=sh:ci:pi:sts=0:sw=4:ts=4:
#
