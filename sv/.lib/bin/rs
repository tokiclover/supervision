#!/bin/sh
#
# $Header:  /lib/sv/bin/rs                               Exp $
# $License: 2-clause/new/simplified BSD                  Exp $
# $Version: 0.2 2015/04/30 21:09:26                      Exp $
#

usage() {
	cat <<-EOH
 usage: rs [OPTIONS] COMMAND SERVICE [ARGUMENTS]
   COMMAND: add|del|remove|restart|start|stop|status|zap
   OPTIONS: [OPTS] COMMAND SERVICE [ARGS]
     -D, --nodeps     Disable dependencies
     -g, --debug      Enable debug mode
   OPTIONS: [OPTS] stage [ARGS]
     -0, --sysinit    Select stage-0
     -1, --boot       Select stage-1
     -2, --default    Select stage-2
     -3, --shutdown   Select stage-3
     -r, --rs         Select runscript
     -v, --sv         Select supervision
     -h, --help       Help/Exit
EOH
${1+exit ${1}}
}

[ ${#} -ge 2 ] || usage 1
ARGS="$(getopt \
	-o 0123Dghrv -l debug,help,nodeps,rs,sv \
	-l boot,default,shutdown,sysinit \
	-s sh -n rs -- "${@}")"
[ ${?} -eq 0 ] || usage 1
eval set -- ${ARGS}

while true; do
	case "${1}" in
		(-D|--node*) SVC_DEPS=0 ;;
		(-r|--rs) OPTS="${1}" ;;
		(-v|--sv) OPTS="${1}" ;;
		(-g|--debug) set -x ;;
		(-h|--help) usage 0 ;;
		(-0|--sysin*) LVL=0 ;;
		(-1|--boot)   LVL=1 ;;
		(-2|--defau*) LVL=2 ;;
		(-3|--shutd*) LVL=3 ;;
		(*) shift;  break   ;;
	esac
	shift
done
RS_HEAD()
{
case "${1}" in
	(/*) head="${1%/*}"   ;;
	(*)  head="${PWD}/${1#./}"
	     head="${head%/*}";;
esac
}
case "${1}" in
	(*rs.d/*)
	RS_HEAD "${1}"
:	${SV_LIBDIR:=${0%/bin*}}
:	${RS_SVCDIR:=${head%/stage-*}}
:	${SVC_NAME:=${1##*/}}
:	${CMD=${2}}
	;;
	(*)
	RS_HEAD "${0}"
:	${SV_LIBDIR:=${head%/bin}}
case "${2}" in
	(stage)
:	${SRC_OPTS=}
:	${CMD=${1} ${2} '-${LVL}'}
	;;
	(*)
:	${CMD=${1}}
	;;
esac
:	${SRC_OPTS=-d}
:	${SVC_NAME=${2}}
	;;
esac
case "${3}" in
	(*-[0123])
:	${LVL:=${3#*-}}
	shift;;
esac
shift 2

:	${RS_SRV=rs}
:	${RS_STAGE:=stage-${LVL:-2}}
:	${name=${SVC_NAME}}
unset head

source ${SV_LIBDIR}/sh/sv-backend ||
	{ echo "Required file not found." >&2; exit 1; }
:	${RS_RUNDIR:=${RS_SVCDIR}/${RS_STAGE}}
ARGS=-C
source "${SV_SVCDIR}"/.opt/SVC_OPTIONS

#
# Handle command
#
eval set -- ${CMD} ${OPTS} "${@}"
eval rs_cmd "${@}"

#
# vim:fenc=utf-8:ft=sh:ci:pi:sts=0:sw=4:ts=4:
#
