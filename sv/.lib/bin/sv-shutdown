#!/bin/sh
#
# $Header:  /lib/sv/bin/sv-shutdown                      Exp $
# $License: 2-clause/new/simplified BSD                  Exp $
# $Description: Simple & Cheap shutdown script           Exp $
# $Version: 0.3 2015/04/24 21:09:26                      Exp $
#

:	${name=${0##*/}}

case "${0}" in
	(/*) head="${0%/*}"   ;;
	(*)  head="${PWD}/${0#./}"
	     head="${head%/*}";;
esac
:	${SV_LIBDIR:=${head%/*}}
source ${SV_LIBDIR}/sh/sv-backend ||
	{ echo "Required file not found." >&2; exit 1; }
svc_backend -C -i

usage() {
	cat <<-EOH
usage: ${0##*/} COMMAND
  -6, -r, --reboot    System reboot
  -0, -s, --shutdown  System shutdown
      -f, --fast      Skip fsck on reboot
      -F, --fsck      Force fsck on reboot
      -t, --time sec  Send signal after waiting
  -?, -h, --help      Help/Exit
EOH
exit
}

ARGS="$(getopt \
	-o \?06Ffhrst: \
	-l fast,fsck,help,reboot,shutdown,time: \
	-s sh -n ${name} -- "${@}")"
[ ${?} -eq 0 ] || usage
eval set -- ${ARGS}

while true; do
case "${1}" in
	(-[6r]|--reboot) LEVEL=6 ACTION=reboot  ;;
	(-[0s]|--shutd*) LEVEL=0 ACTION=shutdown;;
	(-[?h]|--help)   usage      ;;
	(-f|--fa*) touch /fastboot  ;;
	(-F|--fs*) touch /forcefsck ;;
	(-t|--time) TIME=$2; shift  ;;
	(*) shift; break;;
esac
shift
done
case "${SV_OPT}" in
	(daemontoo*) CMD="svc_shutdown" TIME=""            ;;
	(runit) CMD="runit-init ${LEVEL}"                  ;;
	(s6) CMD="${SV_RUNDIR}/.s6-svscan/finish -${LEVEL}";;
esac
case "${LEVEL}" in
	(0) MSG="System halt"   ;;
	(6) MSG="System reboot" ;;
	(*) die "-0|-6 required";;
esac

echo "${@:-${MSG}}" | busybox wall
eval "\
	([ -n '${TIME}' ] && sleep ${TIME}
	eval ${CMD}) \
	${TIME:+&}"

unset CMD LEVEL SHIFT TIME

#
# vim:fenc=utf-8:ft=sh:ci:pi:sts=0:sw=4:ts=4:
#
