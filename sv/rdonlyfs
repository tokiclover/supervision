#!/sbin/rs
#
# $Header: /etc/sv/rdonlyfs                                Exp $
# $License: 2-clause/new/simplified BSD                    Exp $
#

description="Mount filesystem read-only"

start()
{
	[ "${SV_STAGE}" = "${SV_SHUTDOWN_LEVEL}" ] || return 1
	sync

	local dir mnt_opts mnt_point

	mnt_point="/dev|/dev/.*|/proc|/proc/.*|/sys|/sys/.*|/run|/lib.*|/tmp"
	umount=$(command -v umount 2>${NULL})

	for dir in $(mountinfo -P "^(${mnt_point})$" -o rw -N); do
		begin "Unmounting ${dir} (read-only)"
		${umount} -n -r ${dir} 2>${NULL}
		end "${?}"
	done

	if [ "${SV_RUNLEVEL}" = "shutdown" -o "${SV_RUNLEVEL}" = "reboot" ]; then
		sv-shutdown --force --${SV_RUNLEVEL}
	fi
}

#
# vim:fenc=utf-8:ft=sv:ci:pi:sts=0:sw=4:ts=4:
#
