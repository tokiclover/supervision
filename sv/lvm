#!/sbin/sv-run
#
# $Id: @(#) /etc/sv/lvm                                               Exp $
# $L$: 2-clause/new/simplified BSD License                            Exp $
#

description="Set up LVM2 devices"
SVC_AFTER="dev mdev udev kmod device-mapper lvmetad"
SVC_BEFORE="checkfs"
SVC_USE="lvmetad"
SVC_CONFIGFILE="/etc/lvm/lvm.conf"
SVC_KEYWORD="docker jail openvz prefix systemd-nspawn timeout uml vserver xenu lxc"

lvm="$(command -v lvm 2>${NULL})"

start_pre()
{
	if [ -e /proc/modules ]; then
		device_info --all device-mapper || modporbe dm-mod >${NULL} 2>&1
	fi
	checkpath -q -d -m 0700 -o root:root /run/lvm /run/lock/lvm
	[ -n "${lvm}" -a -x "${lvm}" ] && [ -c /dev/mapper/control -a -f ${SVC_CONFIGFILE} ]
}

start()
{
	[ -d /proc/lvm ] || device_info --all device-mapper || return
	if [ -e ${SV_RUNDIR} ]; then
		sv-run -q udev start >${NULL} 2>&1 || UDEV_ARGS=--noudevsync
		ENV_SET UDEV_ARGS
	fi

	${lvm} pvscan
	${lvm} vgscan --mknodes
	${lvm} vgchange ${args} --sysinit --activate ly
}

stop()
{
	[ "${SV_INITLEVEL}" = "${SV_SHUTDOWN_LEVEL}" ] || return
	[ -d /proc/lvm ] || device_info --all device-mapper || return
	${lvm} lvchange ${UDEV_ARGS} --sysinit --activate ln
	${lvm} vgchange ${UDEV_ARGS} --sysinit --activate ln
}

#
# vim:fenc=utf-8:ft=sv:ci:pi:sts=0:sw=4:ts=4:
#
